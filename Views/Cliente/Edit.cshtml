@model ChallengeIntegra.Models.Cliente

@{
    ViewData["Title"] = "Editar Cliente";
}

<h4>@ViewData["Title"]</h4>
<hr />
<div class="row">
    <div class="col-md-6">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            
            <input type="hidden" asp-for="Id" />

            <div class="form-group mb-3">
                <label asp-for="CUIT" class="control-label"></label>
                <div class="input-group">
                    @*
                        Se establece maxlength="13" para permitir pegar CUITS con guiones.
                        El script se encargará de limpiar y validar la longitud final.
                    *@
                    <input asp-for="CUIT" id="cuitInput" class="form-control" inputmode="numeric" pattern="[0-9]*" maxlength="13" />
                    <button class="btn btn-outline-secondary" type="button" id="validateCuitBtn">Validar</button>
                </div>
                @* Este span mostrará el mensaje de error de validación unificado. *@
                <span asp-validation-for="CUIT" class="text-danger"></span>
            </div>

            <div id="razonSocialStatus" class="mb-2"></div>

            <div class="form-group mb-3">
                <label asp-for="RazonSocial" class="control-label"></label>
                <input asp-for="RazonSocial" id="razonSocialInput" class="form-control" readonly="readonly" />
                <span asp-validation-for="RazonSocial" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Telefono" class="control-label"></label>
                <input asp-for="Telefono" class="form-control" inputmode="numeric" pattern="[0-9]*" maxlength="20" />
                <span asp-validation-for="Telefono" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Direccion" class="control-label"></label>
                <input asp-for="Direccion" class="form-control" />
                <span asp-validation-for="Direccion" class="text-danger"></span>
            </div>

            <div class="form-group form-check mb-3">
                <label class="form-check-label">
                    <input class="form-check-input" asp-for="Activo" /> @Html.DisplayNameFor(model => model.Activo)
                </label>
            </div>

            <div class="form-group">
                <input type="submit" value="Guardar" class="btn btn-primary" />
                 | <a asp-action="Index" class="btn btn-secondary">Volver al Listado</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script type="text/javascript">
        $(document).ready(function () {
            
            // --- INICIO DE LA CORRECCIÓN DE VALIDACIÓN ---
            // Forzamos a que las reglas de minlength y maxlength de jQuery Validation
            // usen el mismo mensaje que nuestra data annotation. Esto evita el doble mensaje.
            if ($.validator && $.validator.unobtrusive) {
                var validator = $('form').validate();
                if (validator) {
                    validator.settings.rules.CUIT.minlength = 11;
                    validator.settings.rules.CUIT.maxlength = 11;
                    validator.settings.messages.CUIT = {
                        minlength: "El CUIT debe tener 11 caracteres.",
                        maxlength: "El CUIT debe tener 11 caracteres.",
                        rangelength: "El CUIT debe tener 11 caracteres." // Agregado para unificar el mensaje de longitud
                    };
                }
            }
            // --- FIN DE LA CORRECCIÓN DE VALIDACIÓN ---

            function cleanCuit(cuitValue) {
                return cuitValue.replace(/[^0-9]/g, '');
            }

            $('#cuitInput').on('keypress', function (e) {
                if (e.which < 48 || e.which > 57) {
                    e.preventDefault();
                }
            });

            $('#cuitInput').on('paste', function (e) {
                setTimeout(() => {
                    var cleanedValue = cleanCuit($(this).val());
                    $(this).val(cleanedValue);
                }, 0);
            });

            $('#cuitInput').on('blur', function () {
                var cleanedValue = cleanCuit($(this).val());
                $(this).val(cleanedValue);
                // Forzar la revalidación en el blur para que el mensaje de error aparezca/desaparezca
                $(this).valid();
            });

            $('#validateCuitBtn').on('click', function () {
                var cuit = cleanCuit($('#cuitInput').val());
                $('#cuitInput').val(cuit);

                var razonSocialInput = $('#razonSocialInput');
                var statusDiv = $('#razonSocialStatus');

                razonSocialInput.val('');
                statusDiv.html('');

                // Forzamos la validación completa del campo CUIT antes de la llamada AJAX
                if ($('#cuitInput').valid()) { 
                    statusDiv.html('<span class="text-info">Buscando Razón Social...</span>');

                    $.ajax({
                        url: '@Url.Action("GetNombrePorCuit", "ClienteApi")',
                        type: 'GET',
                        data: { cuit: cuit },
                        success: function (response) {
                            razonSocialInput.val(response.name);
                            statusDiv.html('');
                        },
                        error: function (xhr) {
                            var errorMessage = "No se pudo contactar al servicio.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            statusDiv.html('<span class="text-danger">' + errorMessage + '</span>');
                        }
                    });
                }
            });
        });
    </script>
}